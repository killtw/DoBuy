<?php if ( ! defined('BASEPATH')) exit('No direct script access allowed');class Fetch extends CI_Controller {	function __construct()	{		parent::__construct();		$this->load->library('domparser');	}	function index()	{		$this->yam();		$this->shopping();		$this->one();		$this->gomaji();		$this->groupon();		$this->lashou();		$this->life();		$this->delete();	}	function yam()	{		$url = 'http://jo.yam.com/index.php?view=2';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('h3[class=information] a') as $a)		{			$url = $a->href;			$dom = $this->domparser->file_get_dom($url);			$title = $dom->find('h2[class=bigtitle]', 0)->plaintext;			$image = $dom->find('img[width=390px]', 0)->src;			$price = str_ireplace('$', '', $dom->find('div[class=price]', 0)->plaintext);			$worth = $dom->find('span[class=number]', 2)->plaintext;			preg_match("/stop=(\d{10})/si", $dom->outertext, $match);			$endtime = date('Y-m-d H:i:s', $match[1]);			preg_match("/地址：(.*)</", $dom->outertext, $match);			$address = $match[1];			$city = $this->db_model->city($address);			$category = $this->db_model->category($title);			if($url)			{				$data = array(					'title' => $title,					'city' => $city,					'address' => $address,					'price' => $price,					'worth' => $worth,					'category' => $category,					'endtime' => $endtime,					'url' => $url,					'image' => $image				);				$this->db_model->check_insert('deals', array('url' => $url), $data);			}		}	}	function life()	{		$url = 'http://www.17life.com/ppon/TodayDeals.aspx';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('div[class=DealMainTitle] a') as $a)		{			$url = $a->href;			$dom = $this->domparser->file_get_dom($url);			$title = $dom->find('div[class=MainDealProductName]', 0)->plaintext;			$image = $dom->find('div[class=nivoSlider] img', 0)->src;			preg_match("/\d{1,5}/si", $dom->find('div[id=Price]', 0)->plaintext, $match);			$price = $match[0];			preg_match("/\d{1,5}/si", $dom->find('table[id=DiscountPriceR] td', 0)->plaintext, $match);			$worth = $match[0];			preg_match("/\d{4},\d{1,2},\d{1,2},\d{1,2},\d{1,2},\d{1,2}/si",$dom->outertext, $match);			list($year, $month, $day, $h, $m, $s) = explode(",", $match[0]);			$month = $month + 1;			$endtime = $year.",".$month.",".$day.",".$h.",".$m.",".$s;			$address = $dom->find('div[id=map]', 0)->address;			$city = $this->db_model->city($address);			$category = $this->db_model->category($title);			if($url)			{				$data = array(					'title' => ltrim($title),					'city' => $city,					'address' => $address,					'price' => $price,					'worth' => $worth,					'category' => $category,					'endtime' => $endtime,					'url' => $url,					'image' => $image				);				$this->db_model->check_insert('deals', array('url' => $url), $data);			}		}	}	function shopping()	{		$url = 'http://tp.17shopping.tw/';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('div[id=location] a[class=open_city]') as $city)		{			$url = $city->href;			$dom = $this->domparser->file_get_dom($url);			foreach($dom->find('div[class=goto] a') as $a)			{				$url = $a->href;				$dom = $this->domparser->file_get_dom($url);				$title = trim($dom->find('div[class=todayitemname]', 0)->plaintext);				$image = 'http://www.17shopping.tw' . $dom->find('img[class=productimg]', 0)->src;				$price = str_ireplace('$', '', $dom->find('div[class=price]', 0)->plaintext) + 0;				$worth = $dom->find('td[class=line-through]', 0)->plaintext;				$endtime = $dom->find('span[id=starttimeforcountdown]', 0)->plaintext;				preg_match("/loadmap\(\'(.*)\'\)/", $dom->outertext, $match);				$address = $match[1];				$city = $this->db_model->city($address);				$category = $this->db_model->category($title);				if($url AND !empty($endtime))				{					$data = array(						'title' => $title,						'city' => $city,						'address' => $address,						'price' => $price,						'worth' => $worth,						'category' => $category,						'endtime' => $endtime,						'url' => $url,						'image' => $image					);					$this->db_model->check_insert('deals', array('url' => $url), $data);				}			}		}	}	function gomaji()	{		$url = 'http://www.gomaji.com/';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('div[id=nav-city] a') as $city)		{			$url = 'http://www.gomaji.com'.$city->href;			$dom = $this->domparser->file_get_dom($url);			foreach($dom->find('a[class=product-name]') as $a)			{				$url = 'http://www.gomaji.com/'.$a->href;				$dom = $this->domparser->file_get_dom($url);				$title = $dom->find('span[class=product-name]', 0)->plaintext;				$image = $dom->find('div[class=gallery] img', 0)->src;				$price = str_ireplace('$', '', $dom->find('p[class=price]', 0)->plaintext) + 0;				$worth = str_ireplace('$', '', $dom->find('s', 0)->plaintext) + 0;				preg_match("/gm_countdown\(\'countdown-(\d{4})\', (\d{5,6})\);/si" , $dom->outertext, $match);				$endtime = date("Y-m-d H:i:s", (time() + $match[2]));				$e = $dom->find('a[class=map]', 0);				preg_match("/&q=(.*)&hnear/si", $e->href, $match);				$address = urldecode($match[1]);				$city = $this->db_model->city($address);				$category = $this->db_model->category($title);				if($url)				{					$data = array(						'title' => $title,						'city' => $city,						'address' => $address,						'price' => $price,						'worth' => $worth,						'category' => $category,						'endtime' => $endtime,						'url' => $url,						'image' => $image					);					$this->db_model->check_insert('deals', array('url' => $url), $data);				}			}		}	}	function groupon()	{		$url = 'http://www.groupon.com.tw/advertise/deallist2.php';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('div[class=title18] a') as $a)		{			$url = $a->href;			$dom = $this->domparser->file_get_dom($url);			$title = $dom->find('title', 0)->plaintext;			$image = $dom->find('div[id=img1] div[lazy=img]', 0)->src;			$price = str_ireplace('$', '', $dom->find('div[id=amount]', 0)->plaintext) + 0;			if(!$price) {				preg_match("/(\d{1,5})/", $dom->find('table[style=margin-top:15px]', 0)->plaintext, $match);				$price = $match[1];			}			$worth = str_ireplace('$', '', $dom->find('span[class=discount]', 0)->plaintext) + 0;			$endtime = date("Y-m-d H:i:s", (time() + $dom->find('span[id=timeleft]', 0)->time));			preg_match("/地址：(.*)<br>電話/", $dom->outertext, $match);			$address = $match[1];			$city = $this->db_model->city($address);			$category = $this->db_model->category($title);			if($url)			{				$data = array(					'title' => $title,					'city' => $city,					'address' => $address,					'price' => $price,					'worth' => $worth,					'category' => $category,					'endtime' => $endtime,					'url' => $url,					'image' => $image				);				$this->db_model->check_insert('deals', array('url' => $url), $data);			}		}	}	function one()	{		$url = 'http://www.123.com.tw/?action=list';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('div[class=boxmain] h3 a') as $a)		{			$url = 'http://www.123.com.tw'.$a->href;			$dom = $this->domparser->file_get_dom($url);			$title = $dom->find('meta[property=og:description]', 0)->content;			$image = $dom->find('div[class=team_pic slideshow] img', 0)->src;			$price = str_ireplace(',', '', str_ireplace('$', '', $dom->find('span[class=price_span]', 0)->plaintext)) + 0;			preg_match("/(\d{1,5})/si", $dom->find('span[class=price_1]', 0)->plaintext, $match);			$worth = $match[1] + 0;			preg_match("/countDown\(\'remainTime\',(\d{1,7})\)/si", $dom->outertext, $match);			$endtime = date("Y-m-d H:i:s", (time() + $match[1]));			preg_match("/var treeShopJson = \'\[\[\[\[(.*)]]]]\';var treeShop/si", $dom->outertext, $match);			$address = json_decode($match[1])->address;			$city = $this->db_model->city($address);			$category = $this->db_model->category($title);			if($url)			{				$data = array(					'title' => $title,					'city' => $city,					'address' => $address,					'price' => $price,					'worth' => $worth,					'category' => $category,					'endtime' => $endtime,					'url' => $url,					'image' => $image				);				$this->db_model->check_insert('deals', array('url' => $url), $data);			}		}	}	function lashou()	{		$url = 'http://tw.lashou.com/';		$dom = $this->domparser->file_get_dom($url);		foreach($dom->find('td[class=title] a') as $a)		{			$url = $a->href;			$dom = $this->domparser->file_get_dom($url);			$title = $dom->find('span[class=sub]', 1)->plaintext;			$image = $dom->find('img[width=420]', 0)->src;			$price = str_ireplace('$', '', $dom->find('font[class=num]', 0)->plaintext) + 0;			preg_match("/(\d{1,5})/si", $dom->find('table[class=sub] td[align=center]', 0)->plaintext, $match);			$worth = $match[1];			preg_match("/show_time\((\d{1,7}),(.{10})\);/si", $dom->outertext, $match);			$endtime = date("Y-m-d H:i:s", (time() + $match[1]));			$address = $dom->find('span[id=sp_address]', 0)->plaintext;			$city = $this->db_model->city($address);			$category = $this->db_model->category($title);			if($url)			{				$data = array(					'title' => $title,					'city' => $city,					'address' => $address,					'price' => $price,					'worth' => $worth,					'category' => $category,					'endtime' => $endtime,					'url' => $url,					'image' => $image				);				$this->db_model->check_insert('deals', array('url' => $url), $data);			}		}	}	function delete()	{		$this->db_model->deal_delete();	}}